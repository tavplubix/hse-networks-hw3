# ~~Перекладывание джсонов~~ Выгрузка расписания из РУЗ с возможностью учёта дедлайнов
Приложение делает то, что написано в заголовке: показывает расписание из вышкинского РУЗ 
и позволяет пользователям создавать дедлайны по заданиям по учебным курсам. 
Созданный одним пользователем делайн становится виден всей группе, изучающей некоторый курс. 
Также для дедлайнов можно указывать ожидаемое и фактическое время, которое придётся потратить на выполнение задания.
Другие пользователи будут видеть среднее время для группы. Грабить корованы, к сожалению, нельзя.

## Установка
```
./install.sh
```
(скрипту нужен docker, но, скорее всего, он у вас уже есть)

Если нужно, в `src/settings.py` можно поменять хост и порт сервера. 
Ещё там можно поменять параметры подключения к PostgreSQL и запускать его не в докере, а как-то иначе (но зачем?).

## Запуск сервера
```
./server.py
```
Пишет логи (в том числе информацию и подключении и отключении клиентов) в stdout.

## Клент
Консольный клиент. Вот пример использования:
```
./client.py
cmd> help
Список комманд:
q	 - выход
help	 - показать эту справку
connect HOST PORT	 - подключиться к серверу
disconnect	 - отключиться от сервера
students NAME	 - поиск студентов с именем NAME
register LOGIN PASSWORD STUDENT_ID	 - создание пользователя с привязкой к студенту с STUDENT_ID (из вывода команды students)
login LOGIN PASSWORD	 - залогиниться
logout	 - разлогиниться
groups [STUDENT_ID]	 - список групп по учебным курсам для студента STUDENT_ID (по умолчанию текущий пользователь)
lessons [STUDENT_ID]	 - русписание для студента STUDENT_ID (по умолчанию текущий пользователь)
deadlines	 - список дедлайнов для текущего пользователя
create deadline GROUP_ID DATETIME NAME	 - создать дедлайн для группы GROUP_ID (из вывода groups)
deadline estimated DEADLINE_ID HOURS	 - указать предполагаемое время выполнения задания DEADLINE_ID (из вывода deadlines)
deadline real DEADLINE_ID HOURS	 - указать фактическое время выполнения задания DEADLINE_ID (из вывода deadlines)
cmd> connect localhost 1337
ok
cmd> students токмаков
id	last_name	first_name	patronymic_name	email	group_name
210245	Токмакова	Мария	Сергеевна	mstokmakova@edu.hse.ru	Магистратура группа МТЭК191-2019
167647	Токмакова	Валерия	Игоревна	vitokmakova@edu.hse.ru	Бакалавриат группа БИЯ177-2017
167047	Токмаков	Александр	Викторович	avtokmakov@edu.hse.ru	Бакалавриат группа БПМИ165-2016
Total: 3 rows
cmd> register tokmakov qwerty 167047
ok
cmd> lessons
ERROR: <class 'Exception'> You are not logged in
cmd> login tokmakov qwerty
ok
cmd> lessons
user_id	first_name	lesson_time_id	date	start	end	building_addr	lesson_type	course_short_name	course_full_name
167047	Александр	3	2020-03-14	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	4	2020-03-14	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
167047	Александр	5	2020-03-16	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Научно-исследовательский семинар	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
167047	Александр	3	2020-03-17	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Численные методы (рус)	Численные методы (рус)
167047	Александр	4	2020-03-17	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Численные методы (рус)	Численные методы (рус)
167047	Александр	5	2020-03-18	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Лекция	Функциональное программирование (рус)	Функциональное программирование (рус)
167047	Александр	6	2020-03-18	16:40:00	18:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
167047	Александр	3	2020-03-21	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	4	2020-03-21	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	5	2020-03-21	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	7	2020-03-23	18:10:00	19:30:00	Москва, Покровский б-р, д.11	Экзамен	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
167047	Александр	3	2020-03-24	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Численные методы (рус)	Численные методы (рус)
167047	Александр	4	2020-03-24	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Численные методы (рус)	Численные методы (рус)
167047	Александр	1	2020-03-28	09:00:00	10:20:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	3	2020-03-28	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
167047	Александр	4	2020-03-28	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
Total: 16 rows
cmd> groups
id	name	type
113288	Функциональное программирование (рус)	Семинар
113314	Численные методы (рус)	Семинар
113317	Численные методы (рус)	Лекция
113340	Компьютерные сети (рус)	Семинар
113341	Компьютерные сети (рус)	Лекция
113341	Компьютерные сети (рус)	Экзамен
119219	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	Научно-исследовательский семинар
119219	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	Экзамен
120806	Функциональное программирование (рус)	Лекция
Total: 9 rows
cmd> deadlines
No results
cmd> new deadline 113340 26-03-2020 дз3
ok
cmd> new deadline 113314 30-03-2020 лаба
ok
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00		
Численные методы (рус)	2	лаба	2020-03-30 00:00:00		
Total: 2 rows
cmd> deadline estimated 1 12
ok
cmd> deadline estimated 2 16
ok
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	12:00:00	
Численные методы (рус)	2	лаба	2020-03-30 00:00:00	16:00:00	
Total: 2 rows
cmd> students орлов
id	last_name	first_name	patronymic_name	email	group_name
207700	Орлова	Наталия	-	norlova@edu.hse.ru	Бакалавриат группа БЭК198-2019
196137	Орлов	Артем	Игоревич	aiorlov@edu.hse.ru	Магистратура группа МЛГ192-2019
200831	Орлов	Глеб	Сергеевич	gsorlov@edu.hse.ru	Бакалавриат группа БМБ176-2017
166173	Орлов	Егор	Андреевич	eaorlov@edu.hse.ru	Бакалавриат группа БМН162-2016
191948	Орлов	Лев	Эдуардович	leorlov@edu.hse.ru	Бакалавриат группа 19Э3-2019
196916	Орлов	Петр	Сергеевич	psorlov@edu.hse.ru	Бакалавриат группа БМО194-2019
205295	Орлов	Андрей	Иванович	aiorlov@edu.hse.ru	Бакалавриат группа БРО1912-2019
190726	Орлов	Даниил	Игоревич	diorlov@edu.hse.ru	Бакалавриат группа БЛГ173С-2017
176797	Орлов	Иван	Николаевич	inorlov@edu.hse.ru	Бакалавриат группа БЭК1811-2018
177664	Орлова	Алина	Игоревна	aiorlova@edu.hse.ru	Бакалавриат группа БГУ185-2018
179719	Орлова	Юлия	Сергеевна	jsorlova@edu.hse.ru	Бакалавриат группа ЯЛИР181-2018
187735	Орлов	Антон	Алексеевич	aaorlov@edu.hse.ru	Бакалавриат группа БМОЛ161-2016
180286	Орлов	Евгений	Маркович	emorlov@edu.hse.ru	Бакалавриат группа БКЛ181-2018
165836	Орлов	Никита	Андреевич	naorlov@edu.hse.ru	Бакалавриат группа БПМИ165-2016
189731	Орлов	Роман	Викторович	rvorlov@edu.hse.ru	Магистратура группа МФА181-2018
Total: 15 rows
cmd> register orlov asdf 165836
ERROR: <class 'Exception'> You are logged in
cmd> logout
ok
cmd> register orlov asdf 165836
ok
cmd> login orlov asdf
ok
cmd> lessons
user_id	first_name	lesson_time_id	date	start	end	building_addr	lesson_type	course_short_name	course_full_name
165836	Никита	3	2020-03-14	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-14	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	5	2020-03-16	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Научно-исследовательский семинар	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
165836	Никита	5	2020-03-18	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Лекция	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	6	2020-03-18	16:40:00	18:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	3	2020-03-21	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-21	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	5	2020-03-21	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	7	2020-03-23	18:10:00	19:30:00	Москва, Покровский б-р, д.11	Экзамен	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
165836	Никита	1	2020-03-28	09:00:00	10:20:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	3	2020-03-28	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-28	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	3	2020-03-14	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-14	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	5	2020-03-16	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Научно-исследовательский семинар	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
165836	Никита	2	2020-03-18	10:30:00	11:50:00	Москва, Покровский б-р, д.11	Лекция	Конфликты и кооперация (анг)	Конфликты и кооперация (анг)
165836	Никита	3	2020-03-18	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Семинар	Конфликты и кооперация (анг)	Конфликты и кооперация (анг)
165836	Никита	4	2020-03-18	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Лекция	Конфликты и кооперация (анг)	Конфликты и кооперация (анг)
165836	Никита	5	2020-03-18	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Лекция	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	6	2020-03-18	16:40:00	18:00:00	Москва, Покровский б-р, д.11	Семинар	Функциональное программирование (рус)	Функциональное программирование (рус)
165836	Никита	3	2020-03-21	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Лекция	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-21	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	5	2020-03-21	15:10:00	16:30:00	Москва, Покровский б-р, д.11	Семинар	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	7	2020-03-23	18:10:00	19:30:00	Москва, Покровский б-р, д.11	Научно-исследовательский семинар	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"
165836	Никита	1	2020-03-28	09:00:00	10:20:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	3	2020-03-28	12:10:00	13:30:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
165836	Никита	4	2020-03-28	13:40:00	15:00:00	Москва, Покровский б-р, д.11	Экзамен	Компьютерные сети (рус)	Компьютерные сети (рус)
Total: 27 rows
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	12:00:00	
Total: 1 rows
cmd> groups
id	name	type
112738	Конфликты и кооперация (анг)	Семинар
112739	Конфликты и кооперация (анг)	Лекция
113288	Функциональное программирование (рус)	Семинар
113340	Компьютерные сети (рус)	Семинар
113341	Компьютерные сети (рус)	Лекция
113341	Компьютерные сети (рус)	Экзамен
119219	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	Научно-исследовательский семинар
119219	"Научно-исследовательский семинар ""Распределенные системы 2"" (рус)"	Экзамен
120806	Функциональное программирование (рус)	Лекция
Total: 9 rows
cmd> deadline estimated 1 10
ok
cmd> deadline real 1 24
ok
cmd> new deadline 112739 01-04-2020 экз
ok
cmd> new deadline 113288 02-04-2020 F
ok
cmd> deadlines          
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Конфликты и кооперация (анг)	3	экз	2020-04-01 00:00:00		
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	11:00:00	1 day, 0:00:00
Функциональное программирование (рус)	4	F	2020-04-02 00:00:00		
Total: 3 rows
cmd> deadline estimated 4 123
ok
cmd> deadline real 4 1234
ok
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Конфликты и кооперация (анг)	3	экз	2020-04-01 00:00:00		
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	11:00:00	1 day, 0:00:00
Функциональное программирование (рус)	4	F	2020-04-02 00:00:00	5 days, 3:00:00	51 days, 10:00:00
Total: 3 rows
cmd> logout
ok
cmd> login tokmakov qwer
ERROR: <class 'Exception'> Wrong login or password
cmd> login tokmakov qwerty
ok
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	11:00:00	1 day, 0:00:00
Функциональное программирование (рус)	4	F	2020-04-02 00:00:00	5 days, 3:00:00	51 days, 10:00:00
Численные методы (рус)	2	лаба	2020-03-30 00:00:00	16:00:00	
Total: 3 rows
cmd> deadline real 1 25
ok
cmd> deadlines
course_name	deadline_id	deadline_name	deadline_time	estimated_time	real_time
Компьютерные сети (рус)	1	дз3	2020-03-26 00:00:00	11:00:00	1 day, 0:30:00
Функциональное программирование (рус)	4	F	2020-04-02 00:00:00	5 days, 3:00:00	51 days, 10:00:00
Численные методы (рус)	2	лаба	2020-03-30 00:00:00	16:00:00	
Total: 3 rows
cmd> q
```

## Протокол
На самом деле это два протокола на разных уровнях.

### Уровень перекладывания джсонов (поверх TCP)
Простой протокол. Надёжный как швейцарские часы. Клиент и сервер обмениваются некоторыми "пакетами". 
"Пакет" в этом протоколе состоит из 4 байт заголовка, содержащих размер (в байтах) полезной нагрузки
и, собственно, этого количества байт полезной нагрузки, которая представляет собой JSON. 
Размер полезной нагрузки в big endian. Реализация в `send_packet(...)` и `recv_packet(...)` 
в `Session` в `src/server_frontend_tcp.py` 

### Уровень приложения (поверх джсонов)
Запрос клиента должен быть JSON-словарём. 
Он обязательно должен содержать ключ `method` со строковым значением.
Это название команды, которую хочет выполнить клиент. Остальные ключи в JSON являются агрументами команды.
Если JSON содержит ключи, имена которых не используются командой, такие ключи игнорируются.
Ответ сервера тоже JSON-словарь. Он обязательно содержит ключ `status` со строковым значением, которое может
быть либо `ok` (запрос успешно выполнился), либо `fail` (что-то пошло не так). 
В первом случае JSON также содержит ключ `data`, значение котрого является результатом запроса (см. далее).
Во втором случае JSON сожержит ключ `exception` со строковым значением, которое описывает, что пошло не так.

Доступные команды:
#### `get_user_info`
Один строковой аргумент с ключом `user_name`. Находит студентов по ~~айпи~~ имени. 
Возвращает массив словарей с информацией о студентах (в том числе `id` студента). 
#### `get_contingent_by_user_id`
Один опциональный целочисленный аргумент `user_id` - идентификатор студента. 
Если не указан, используется `id` подключенного пользователя (если он не залогинен, 
запрос завершится со статусом `fail`). Возврящает массив словарей с описанием групп студентов, 
изучающих различные курсы (в том числе `id` группы).
#### `get_timetable` 
Три опциональных аргумента:
- `user_id` - число, идентификатор студента (по умолчанию текущий пользователь)
- `time_start` - строка в формате 'DD-MM-YYYY', дата начала периода (по умолчанию сегодня минус 14 дней)
- `time_end` - строка в формате 'DD-MM-YYYY', дата конца периода (по умолчанию сегодня плюс 14 дней)

Возвращает массив словарей с описанием пар за указанный период для указаного студента
#### `get_deadlines`
Два опциональных аргумента:
- `time_start` - строка в формате 'DD-MM-YYYY', дата начала периода (по умолчанию сегодня минус 7 дней)
- `time_end` - строка в формате 'DD-MM-YYYY', дата конца периода (по умолчанию сегодня плюс 365 дней)

Возвращает массив словарей с описанием дедлайнов за указанный период для текущего пользователя 
(доступно только залогиненным пользователям).

#### `create_deadline`
Три обязательных аргумента:
- `contingent_id` - число, идентификатор группы
- `time` - строка в формате 'DD-MM-YYYY', дата дедлайна 
- `name` - строка, название делайна

Два опциональных аргумента:
- `weight` - float, вес задания в оценке (по умолчанию 0) 
- `desc` - строка, описание задания (по усолчанию пустая строка)

Создаёт дедлайн для указанной группы. Возвращает пустой словарь.
#### `change_deadline_estimate`
Два обязательных аргумента:
- `deadline_id` - число, идентификатор дедлайна
- `val` - float, время в часах

Устанавливает время, которое текущий пользователь планирует потратить на выполнение задания `deadline_id`. 
Возвращает пустой словарь.
#### `change_deadline_real`
Два обязательных аргумента:
- `deadline_id` - число, идентификатор дедлайна
- `val` - float, время в часах

Устанавливает время, которое текущий пользователь потратил на выполнение задания `deadline_id`.
Возвращает пустой словарь.

#### `register`
- `login` - строка из символов `a-z`, логин пользователя
- `password` - строка, пароль
- `student_id` - число, идентификатор студента

Создаёт нового пользователя и привязывает его к указанному студенту. 
Здесь могла быть ~~ваша реклама~~ отправка какого-нибудь кода подтверждения на @edu.hse.ru почту,
но по понятным причинам её нет. Возвращает пустой словарь.
#### `login`
- `login` - строка из символов `a-z`, логин пользователя
- `password` - строка, пароль

Логинит пользователя. После выполнения этой команды сервер запонит `student_id` для текущего подключения. 
Возвращает пустой словарь.
#### `logout`
Разлогинивает пользователя. Возвращает пустой словарь.


